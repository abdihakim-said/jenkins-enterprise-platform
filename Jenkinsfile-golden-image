#!/usr/bin/env groovy
// Jenkins Golden Image Pipeline
// Epic 2.4: DevSecOps pipeline to build & scan golden image

pipeline {
    agent any
    
    // DevSecOps: Quarterly AMI updates for security and compliance
    triggers {
        cron('H 2 1 */3 *')  // Every 3 months on 1st at 2 AM
    }
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['staging', 'production', 'dev'],
            description: 'Target environment for AMI'
        )
        choice(
            name: 'INSTANCE_TYPE',
            choices: ['t3.medium', 't3.large', 'm5.large', 'm5.xlarge'],
            description: 'Instance type for AMI building'
        )
        booleanParam(
            name: 'SKIP_SECURITY_SCAN',
            defaultValue: false,
            description: 'Skip security scanning (not recommended for production)'
        )
        booleanParam(
            name: 'FORCE_REBUILD',
            defaultValue: false,
            description: 'Force rebuild even if no changes detected'
        )
        string(
            name: 'JENKINS_VERSION',
            defaultValue: '2.426.1',
            description: 'Jenkins version to install'
        )
        booleanParam(
            name: 'ENABLE_DR_SYNC',
            defaultValue: true,
            description: 'Sync AMI to disaster recovery region'
        )
    }
    
    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        PACKER_LOG = '1'
        TRIVY_CACHE_DIR = '/tmp/trivy-cache'
        SLACK_CHANNEL = '#devops-alerts'
        BUILD_TIMESTAMP = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()
        AMI_NAME_PREFIX = "jenkins-golden-ami-${params.ENVIRONMENT}"
        DR_REGION = 'us-west-2'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 2, unit: 'HOURS')
        timestamps()
        skipDefaultCheckout()
    }
    
    stages {
        stage('üöÄ Initialize') {
            steps {
                script {
                    // Clean workspace
                    cleanWs()
                    
                    // Checkout the repository to get Packer files
                    checkout scm
                    
                    // Set build description
                    currentBuild.description = "Environment: ${params.ENVIRONMENT} | Instance: ${params.INSTANCE_TYPE}"
                    
                    // Validate parameters
                    if (!params.ENVIRONMENT) {
                        error("Environment parameter is required")
                    }
                    
                    echo """
                    üèóÔ∏è Jenkins Golden Image Pipeline Started
                    ==========================================
                    Environment: ${params.ENVIRONMENT}
                    Instance Type: ${params.INSTANCE_TYPE}
                    Jenkins Version: ${params.JENKINS_VERSION}
                    Build Timestamp: ${env.BUILD_TIMESTAMP}
                    Skip Security Scan: ${params.SKIP_SECURITY_SCAN}
                    Force Rebuild: ${params.FORCE_REBUILD}
                    ==========================================
                    """
                }
            }
        }
        
        stage('üîç Pre-flight Checks') {
            parallel {
                stage('Validate AWS Credentials') {
                    steps {
                        script {
                            sh '''#!/bin/bash
                                echo "üîê Validating AWS credentials..."
                                aws sts get-caller-identity
                                aws ec2 describe-regions --region ${AWS_DEFAULT_REGION}
                            '''
                        }
                    }
                }
                
                stage('Check Dependencies') {
                    steps {
                        script {
                            sh '''#!/bin/bash
                                echo "üì¶ Checking required tools..."
                                packer version
                                terraform version
                                trivy version
                                docker --version
                            '''
                        }
                    }
                }
                
                stage('Validate Terraform') {
                    steps {
                        script {
                            sh '''#!/bin/bash
                                echo "üèóÔ∏è Validating Terraform configuration..."
                                terraform init -backend=false
                                terraform validate
                                terraform fmt -check=true
                            '''
                        }
                    }
                }
            }
        }
        
        stage('üèóÔ∏è Prepare Packer Variables') {
            steps {
                script {
                    sh '''#!/bin/bash
                        echo "üèóÔ∏è Preparing Packer variables..."
                        cd packer
                        
                        # Create simple variables file
                        cat > build.auto.pkrvars.hcl << EOF
aws_region = "${AWS_DEFAULT_REGION}"
environment = "${ENVIRONMENT}"
instance_type = "${INSTANCE_TYPE}"
EOF
                        
                        echo "‚úÖ Packer variables ready"
                    '''
                }
            }
        }
        
        stage('üî® Build Golden AMI') {
            steps {
                script {
                    sh """#!/bin/bash
                        echo "üî® Building Jenkins Golden AMI..."
                        cd packer
                        
                        # Initialize Packer
                        packer init jenkins-ami.pkr.hcl
                        
                        # Validate Packer configuration
                        packer validate jenkins-ami.pkr.hcl
                        
                        # Build AMI with proper logging
                        packer build -machine-readable jenkins-ami.pkr.hcl 2>&1 | tee packer-build.log
                        
                        # Extract AMI ID with multiple fallback methods
                        AMI_ID=""
                        if [ -f manifest.json ]; then
                            AMI_ID=\$(jq -r '.builds[-1].artifact_id' manifest.json 2>/dev/null | cut -d':' -f2)
                        fi
                        
                        if [ -z "\$AMI_ID" ] && [ -f packer-build.log ]; then
                            AMI_ID=\$(grep "artifact,0,id" packer-build.log | tail -1 | cut -d',' -f6 | cut -d':' -f2)
                        fi
                        
                        if [ -z "\$AMI_ID" ] && [ -f packer-build.log ]; then
                            AMI_ID=\$(grep -o "ami-[0-9a-f]\\{8,17\\}" packer-build.log | tail -1)
                        fi
                        
                        # Validate AMI ID format
                        if [[ "\$AMI_ID" =~ ^ami-[0-9a-f]{8,17}\$ ]]; then
                            echo "Built AMI ID: \$AMI_ID"
                            echo "\$AMI_ID" > ../ami-id.txt
                        else
                            echo "ERROR: Failed to extract valid AMI ID. Found: '\$AMI_ID'"
                            echo "Checking packer-build.log for debugging..."
                            tail -20 packer-build.log
                            exit 1
                        fi
                        
                        # Tag the AMI
                        if [ -n "\$AMI_ID" ] && [[ "\$AMI_ID" =~ ^ami-[0-9a-f]{8,17}\$ ]]; then
                            aws ec2 create-tags \\
                                --resources "\$AMI_ID" \\
                                --tags \\
                                    Key=BuildNumber,Value="${BUILD_NUMBER}" \\
                                    Key=JenkinsVersion,Value="${params.JENKINS_VERSION}" \\
                                    Key=BuildTimestamp,Value="\$(date '+%Y-%m-%d_%H-%M-%S')" \\
                                --region "${AWS_DEFAULT_REGION}"
                            echo "‚úÖ AMI tagged successfully"
                        else
                            echo "ERROR: Invalid AMI_ID '\$AMI_ID', cannot tag AMI"
                            exit 1
                        fi
                    """
                }
            }
        }
        
        stage('üîí Security Scanning') {
            when {
                expression { !params.SKIP_SECURITY_SCAN }
            }
            parallel {
                stage('Trivy Filesystem Scan') {
                    steps {
                        script {
                            sh '''#!/bin/bash
                                echo "üîç Running Trivy filesystem scan on Packer scripts..."
                                
                                # Scan Packer scripts and configurations
                                trivy fs --severity HIGH,CRITICAL \
                                    --format json \
                                    --output trivy-packer-report.json \
                                    packer/
                                
                                # Display results
                                trivy fs --severity HIGH,CRITICAL packer/
                                
                                # Check for critical issues
                                CRITICAL_COUNT=\$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-packer-report.json 2>/dev/null || echo "0")
                                
                                echo "Critical vulnerabilities found: \${CRITICAL_COUNT}"
                                
                                if [ "\${CRITICAL_COUNT}" -gt "0" ]; then
                                    echo "‚ö†Ô∏è Critical vulnerabilities found in Packer configuration"
                                fi
                            '''
                        }
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'trivy-packer-report.json', allowEmptyArchive: true
                        }
                    }
                }
                
                stage('AWS Inspector V2') {
                    steps {
                        script {
                            sh '''#!/bin/bash
                                echo "üîç Enabling AWS Inspector V2 for AMI scanning..."
                                
                                # Get AMI ID
                                AMI_ID=\$(cat ami-id.txt)
                                
                                if [ -z "\$AMI_ID" ]; then
                                    echo "ERROR: AMI_ID not found"
                                    exit 1
                                fi
                                
                                # Enable Inspector V2 if not already enabled
                                aws inspector2 enable --resource-types ECR EC2 --region \${AWS_DEFAULT_REGION} 2>/dev/null || true
                                
                                # Tag AMI for Inspector scanning
                                aws ec2 create-tags \
                                    --resources "\$AMI_ID" \
                                    --tags Key=InspectorScan,Value=true Key=BuildNumber,Value="\${BUILD_NUMBER}" \
                                    --region "\${AWS_DEFAULT_REGION}"
                                
                                echo "‚úÖ AMI tagged for Inspector V2 scanning"
                                echo "Note: Inspector V2 will automatically scan this AMI"
                                echo "View results in AWS Inspector console after ~15 minutes"
                            '''
                        }
                    }
                }
                
                stage('TFSec Scan') {
                    steps {
                        script {
                            sh '''#!/bin/bash
                                echo "üîç Running TFSec scan on Terraform code..."
                                
                                # Scan Terraform configurations
                                docker run --rm -v \$(pwd):/src aquasec/tfsec /src \
                                    --format json \
                                    --out tfsec-report.json \
                                    --soft-fail || true
                                
                                # Display results
                                docker run --rm -v \$(pwd):/src aquasec/tfsec /src || true
                                
                                echo "‚úÖ TFSec scan completed"
                            '''
                        }
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'tfsec-report.json', allowEmptyArchive: true
                        }
                    }
                }
            }
        }
        
        stage('‚úÖ AMI Validation') {
            steps {
                script {
                    sh '''#!/bin/bash
                        echo "‚úÖ Validating AMI..."
                        
                        # Get AMI ID
                        AMI_ID=\$(cat ami-id.txt)
                        
                        # Verify AMI exists and is available
                        AMI_STATE=\$(aws ec2 describe-images \
                            --image-ids "\$AMI_ID" \
                            --query 'Images[0].State' \
                            --output text \
                            --region "\${AWS_DEFAULT_REGION}")
                        
                        echo "AMI State: \$AMI_STATE"
                        
                        if [ "\$AMI_STATE" = "available" ]; then
                            echo "‚úÖ AMI is available and ready"
                        else
                            echo "‚ö†Ô∏è AMI state: \${AMI_STATE}"
                        fi
                        
                        # Get AMI details
                        aws ec2 describe-images \
                            --image-ids "\$AMI_ID" \
                            --query 'Images[0].[Name,CreationDate,BlockDeviceMappings[0].Ebs.VolumeSize]' \
                            --output table \
                            --region "\${AWS_DEFAULT_REGION}"
                    '''
                }
            }
        }
        
        stage('üìã Generate AMI Manifest') {
            steps {
                script {
                    sh '''#!/bin/bash
                        echo "üìã Generating AMI manifest..."
                        
                        # Get AMI ID
                        AMI_ID=\$(cat ami-id.txt)
                        
                        # Get AMI details
                        aws ec2 describe-images --image-ids "\$AMI_ID" --output json --region "\${AWS_DEFAULT_REGION}" > ami-details.json
                        
                        echo "‚úÖ AMI manifest generated"
                        echo "AMI ID: \$AMI_ID"
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'packer/manifest.json,ami-details.json,ami-id.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('üöÄ Deployment Instructions') {
            steps {
                script {
                    sh '''#!/bin/bash
                        echo "üöÄ AMI ready for deployment..."
                        
                        # Get AMI ID
                        AMI_ID=\$(cat ami-id.txt)
                        
                        echo ""
                        echo "‚úÖ New Golden AMI: \$AMI_ID"
                        echo ""
                        echo "To deploy this AMI:"
                        echo "  1. Terraform will automatically use latest AMI"
                        echo "  2. Or trigger instance refresh:"
                        echo ""
                        echo "     aws autoscaling start-instance-refresh \\"
                        echo "       --auto-scaling-group-name \${ENVIRONMENT}-jenkins-enterprise-platform-asg \\"
                        echo "       --region \${AWS_DEFAULT_REGION}"
                        echo ""
                    '''
                }
            }
        }
        
        stage('üîÑ Disaster Recovery Sync') {
            when {
                expression { params.ENABLE_DR_SYNC }
            }
            steps {
                script {
                    sh '''#!/bin/bash
                        echo "üîÑ Syncing AMI to disaster recovery region..."
                        
                        # Get AMI ID
                        AMI_ID=\$(cat ami-id.txt)
                        
                        # Validate AMI ID before proceeding
                        if [ -z "\$AMI_ID" ] || [[ ! "\$AMI_ID" =~ ^ami-[0-9a-f]{8,17}\$ ]]; then
                            echo "ERROR: Invalid or missing AMI ID: '\$AMI_ID'"
                            exit 1
                        fi
                        
                        # Copy AMI to DR region
                        DR_AMI_ID=\$(aws ec2 copy-image \
                            --source-region "\${AWS_DEFAULT_REGION}" \
                            --source-image-id "\$AMI_ID" \
                            --region "\${DR_REGION}" \
                            --name "jenkins-dr-\${ENVIRONMENT}-\$(date +%Y%m%d_%H%M%S)" \
                            --description "DR copy of \$AMI_ID" \
                            --query 'ImageId' --output text)
                        
                        # Validate DR AMI ID
                        if [ -z "\$DR_AMI_ID" ] || [[ ! "\$DR_AMI_ID" =~ ^ami-[0-9a-f]{8,17}\$ ]]; then
                            echo "ERROR: Failed to create DR AMI. Response: '\$DR_AMI_ID'"
                            exit 1
                        fi
                        
                        # Tag DR AMI
                        aws ec2 create-tags --region "\${DR_REGION}" --resources "\$DR_AMI_ID" --tags \
                            Key=SourceAMI,Value="\$AMI_ID" \
                            Key=DRRegion,Value="\${DR_REGION}" \
                            Key=Environment,Value="\${ENVIRONMENT}" \
                            Key=BuildNumber,Value="\${BUILD_NUMBER}"
                        
                        echo "‚úÖ DR AMI created: \$DR_AMI_ID in \${DR_REGION}"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Archive build artifacts
                archiveArtifacts artifacts: '**/*.log,**/*.json,**/*.txt', allowEmptyArchive: true
                
                // Publish test results if available
                if (fileExists('test-results.xml')) {
                    publishTestResults testResultsPattern: 'test-results.xml'
                }
                
                // Clean workspace
                cleanWs()
            }
        }
        
        success {
            script {
                def amiId = ""
                if (fileExists('ami-id.txt')) {
                    amiId = readFile('ami-id.txt').trim()
                } else if (fileExists('packer/ami-id.txt')) {
                    amiId = readFile('packer/ami-id.txt').trim()
                } else {
                    amiId = "Unknown"
                }
                def message = """
üéâ Jenkins Golden AMI Build Successful!

Environment: ${params.ENVIRONMENT}
AMI ID: ${amiId}
Jenkins Version: ${params.JENKINS_VERSION}
Build Number: ${BUILD_NUMBER}
Duration: ${currentBuild.durationString}

The new AMI has been validated and is ready for deployment.
"""
                
                // Send notification (Slack disabled)
                echo """
üéâ Jenkins Golden AMI Build Successful!

Environment: ${params.ENVIRONMENT}
AMI ID: ${amiId}
Jenkins Version: ${params.JENKINS_VERSION}
Build Number: ${BUILD_NUMBER}
Duration: ${currentBuild.durationString}

The new AMI has been validated and is ready for deployment.
"""
                
                // Update build description
                currentBuild.description = "‚úÖ SUCCESS | AMI: ${amiId}"
            }
        }
        
        failure {
            script {
                def message = """
‚ùå Jenkins Golden AMI Build Failed!

Environment: ${params.ENVIRONMENT}
Build Number: ${BUILD_NUMBER}
Duration: ${currentBuild.durationString}

Please check the build logs for details.
"""
                
                // Send notification (Slack disabled)
                echo """
‚ùå Jenkins Golden AMI Build Failed!

Environment: ${params.ENVIRONMENT}
Build Number: ${BUILD_NUMBER}
Duration: ${currentBuild.durationString}

Please check the build logs for details.
"""
                
                // Update build description
                currentBuild.description = "‚ùå FAILED | Check logs"
            }
        }
        
        unstable {
            script {
                echo "‚ö†Ô∏è Jenkins Golden AMI Build Unstable - Build #${BUILD_NUMBER}"
            }
        }
    }
}
